# -*- mode: ruby -*-# -*- mode: ruby -*-

# vi: set ft=ruby :# vi: set ft=ruby :



# Detective VM Configuration# Agent VM Configuration

# This VM connects to the internal network of the DNS server# This VM connects to the internal network of the DNS server

Vagrant.configure("2") do |config|Vagrant.configure("2") do |config|

  # Base box for the detective  # Base box for the agent

  config.vm.box = "open_network_security/detective"  config.vm.box = "ubuntu/jammy64"

  config.vm.box_version = "0.1.0"

  # Disable default synced folder for better isolation

  # Disable default synced folder for better isolation  config.vm.synced_folder ".", "/vagrant", disabled: true

  config.vm.synced_folder ".", "/vagrant", disabled: true

  # Connect to the same internal network as the DNS server

  # Connect to the same internal network as the DNS server  # This will put the agent on the same network as the DNS server (192.168.10.1)

  # This will put the detective on the same network as the DNS server (192.168.10.1)  # The agent will get an IP from the DHCP server (192.168.10.3-192.168.10.100)

  # The detective will get an IP from the DHCP server (192.168.10.3-192.168.10.100)  config.vm.network "private_network", 

  config.vm.network "private_network",                     type: "dhcp", 

                    type: "dhcp",                     virtualbox__intnet: "labnet"

                    virtualbox__intnet: "labnet"

  # Alternative: Assign a static IP if you prefer (uncomment the line below and comment the DHCP line above)

  # Alternative: Assign a static IP if you prefer (uncomment the line below and comment the DHCP line above)  # config.vm.network "private_network", ip: "192.168.10.10", virtualbox__intnet: "labnet"

  # config.vm.network "private_network", ip: "192.168.10.11", virtualbox__intnet: "labnet"

  # VirtualBox provider configuration

  # VirtualBox provider configuration  config.vm.provider "virtualbox" do |vb|

  config.vm.provider "virtualbox" do |vb|    # Display the VirtualBox GUI when booting the machine

    # Display the VirtualBox GUI when booting the machine    vb.gui = true

    vb.gui = true    

        # Customize the amount of memory on the VM

    # Customize the amount of memory on the VM    vb.memory = "2048"

    vb.memory = "2048"    

        # Set the number of CPUs on the VM

    # Set the number of CPUs on the VM    vb.cpus = 2

    vb.cpus = 2    

        # Set VM name

    # Set VM name    vb.name = "agent-vm"

    vb.name = "detective-vm"  end

  end

  # Provisioning script to configure the agent

  # Provisioning script to configure the detective  config.vm.provision "shell", inline: <<-SHELL

  config.vm.provision "shell", inline: <<-SHELL    # Update system

    # Update system    apt-get update

    apt-get update    

        # Install useful tools for network testing and debugging

    # Install useful tools for network testing and debugging    apt-get install -y net-tools dnsutils curl wget nmap

    apt-get install -y net-tools dnsutils curl wget nmap

    # Configure DNS to use our DNS server

    # Configure DNS to use our DNS server    # This will be set automatically via DHCP, but we can verify/override if needed

    # This will be set automatically via DHCP, but we can verify/override if needed    echo "nameserver 192.168.10.1" > /etc/resolv.conf

    echo "nameserver 192.168.10.1" > /etc/resolv.conf    echo "search local" >> /etc/resolv.conf

    echo "search local" >> /etc/resolv.conf    

        # Prevent NetworkManager from overriding resolv.conf

    # Prevent NetworkManager from overriding resolv.conf    chattr +i /etc/resolv.conf

    chattr +i /etc/resolv.conf    

        # Display network configuration

    # Display network configuration    echo "=== Network Configuration ==="

    echo "=== Network Configuration ==="    ip addr show

    ip addr show    echo "=== DNS Configuration ==="

    echo "=== DNS Configuration ==="    cat /etc/resolv.conf

    cat /etc/resolv.conf    echo "=== Testing DNS Resolution ==="

    echo "=== Testing DNS Resolution ==="    nslookup google.com 192.168.10.1 || echo "DNS server not yet available"

    nslookup google.com 192.168.10.1 || echo "DNS server not yet available"    

        echo "Agent VM setup complete!"

    echo "Detective VM setup complete!"  SHELL

  SHELLend
end